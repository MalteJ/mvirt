syntax = "proto3";
package mvirt.node;

// NodeService - gRPC API for mvirt-node agents
//
// This service provides:
// - Node registration and heartbeat
// - Spec streaming (API → Node) for reconciliation
// - Status updates (Node → API) for actual state
service NodeService {
    // Node lifecycle
    rpc Register(RegisterRequest) returns (RegisterResponse);
    rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
    rpc Deregister(DeregisterRequest) returns (DeregisterResponse);

    // Spec streaming (API → Node)
    // Node calls this to receive spec changes for reconciliation
    rpc WatchSpecs(WatchSpecsRequest) returns (stream SpecEvent);

    // Status updates (Node → API)
    rpc UpdateResourceStatus(UpdateResourceStatusRequest) returns (UpdateResourceStatusResponse);
}

// =============================================================================
// Node Lifecycle Messages
// =============================================================================

message RegisterRequest {
    string node_id = 1;           // UUID (generated by node or provided)
    string name = 2;              // Hostname
    string address = 3;           // gRPC endpoint for this node
    NodeResources resources = 4;   // Initial resource capacity
    map<string, string> labels = 5; // Scheduling labels
}

message RegisterResponse {
    string node_id = 1;           // Confirmed node ID
    bool success = 2;
    string message = 3;           // Error message if !success
    uint64 initial_revision = 4;  // Spec revision to start watching from
}

message HeartbeatRequest {
    string node_id = 1;
    NodeResources current_resources = 2; // Updated resource availability
}

message HeartbeatResponse {
    bool success = 1;
    string message = 2;
}

message DeregisterRequest {
    string node_id = 1;
}

message DeregisterResponse {
    bool success = 1;
    string message = 2;
}

// =============================================================================
// Resource Types
// =============================================================================

message NodeResources {
    uint32 cpu_cores = 1;
    uint64 memory_mb = 2;
    uint64 storage_gb = 3;
    uint32 available_cpu_cores = 4;
    uint64 available_memory_mb = 5;
    uint64 available_storage_gb = 6;
}

// =============================================================================
// Spec Streaming (API → Node)
// =============================================================================

message WatchSpecsRequest {
    string node_id = 1;
    uint64 since_revision = 2;    // Resume from this revision (0 = from start)
}

// SpecEvent contains a change to be applied by the node
message SpecEvent {
    uint64 revision = 1;          // Monotonically increasing revision
    SpecEventType type = 2;
    oneof spec {
        NetworkSpec network = 3;
        VmSpec vm = 4;
        NicSpec nic = 5;
    }
}

enum SpecEventType {
    SPEC_EVENT_TYPE_UNSPECIFIED = 0;
    SPEC_EVENT_TYPE_CREATE = 1;
    SPEC_EVENT_TYPE_UPDATE = 2;
    SPEC_EVENT_TYPE_DELETE = 3;
}

// NetworkSpec - desired state for a network on this node
message NetworkSpec {
    string id = 1;
    string name = 2;
    bool ipv4_enabled = 3;
    string ipv4_subnet = 4;
    bool ipv6_enabled = 5;
    string ipv6_prefix = 6;
    repeated string dns_servers = 7;
    repeated string ntp_servers = 8;
    bool is_public = 9;
}

// VmSpec - desired state for a VM
message VmSpec {
    string id = 1;
    string name = 2;
    string node_id = 3;           // Assigned to this node
    uint32 cpu_cores = 4;
    uint64 memory_mb = 5;
    uint64 disk_gb = 6;
    string network_id = 7;
    string nic_id = 8;
    string image = 9;             // Boot image reference
    VmDesiredState desired_state = 10;
}

enum VmDesiredState {
    VM_DESIRED_STATE_UNSPECIFIED = 0;
    VM_DESIRED_STATE_RUNNING = 1;
    VM_DESIRED_STATE_STOPPED = 2;
}

// NicSpec - desired state for a NIC
message NicSpec {
    string id = 1;
    string name = 2;
    string network_id = 3;
    string mac_address = 4;
    string ipv4_address = 5;
    string ipv6_address = 6;
    repeated string routed_ipv4_prefixes = 7;
    repeated string routed_ipv6_prefixes = 8;
}

// =============================================================================
// Status Updates (Node → API)
// =============================================================================

message UpdateResourceStatusRequest {
    string node_id = 1;
    oneof status {
        NetworkStatus network_status = 2;
        VmStatus vm_status = 3;
        NicStatus nic_status = 4;
    }
}

message UpdateResourceStatusResponse {
    bool success = 1;
    string message = 2;
}

// NetworkStatus - actual state of a network on this node
message NetworkStatus {
    string id = 1;
    ResourcePhase phase = 2;
    string message = 3;           // Error message if phase is FAILED
    string bridge_name = 4;       // Actual bridge device name
}

// VmStatus - actual state of a VM
message VmStatus {
    string id = 1;
    VmPhase phase = 2;
    string message = 3;
    string ip_address = 4;        // Assigned IP address
    uint64 pid = 5;               // Hypervisor process PID
}

// NicStatus - actual state of a NIC
message NicStatus {
    string id = 1;
    ResourcePhase phase = 2;
    string message = 3;
    string socket_path = 4;       // vhost-user socket path
}

// Common resource phase
enum ResourcePhase {
    RESOURCE_PHASE_UNSPECIFIED = 0;
    RESOURCE_PHASE_PENDING = 1;
    RESOURCE_PHASE_CREATING = 2;
    RESOURCE_PHASE_READY = 3;
    RESOURCE_PHASE_UPDATING = 4;
    RESOURCE_PHASE_DELETING = 5;
    RESOURCE_PHASE_FAILED = 6;
}

// VM-specific phase
enum VmPhase {
    VM_PHASE_UNSPECIFIED = 0;
    VM_PHASE_PENDING = 1;
    VM_PHASE_SCHEDULED = 2;
    VM_PHASE_CREATING = 3;
    VM_PHASE_RUNNING = 4;
    VM_PHASE_STOPPING = 5;
    VM_PHASE_STOPPED = 6;
    VM_PHASE_FAILED = 7;
}
