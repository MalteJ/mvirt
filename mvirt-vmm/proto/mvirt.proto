syntax = "proto3";
package mvirt;

// ============================================
// Core Types
// ============================================

enum VmState {
  VM_STATE_UNSPECIFIED = 0;
  VM_STATE_STOPPED = 1;
  VM_STATE_STARTING = 2;
  VM_STATE_RUNNING = 3;
  VM_STATE_STOPPING = 4;
}

message Vm {
  string id = 1;
  optional string name = 2;
  VmState state = 3;
  VmConfig config = 4;
  int64 created_at = 5;
  optional int64 started_at = 6;
}

enum BootMode {
  BOOT_MODE_UNSPECIFIED = 0;
  BOOT_MODE_DISK = 1;    // Boot from disk using firmware (UEFI)
  BOOT_MODE_KERNEL = 2;  // Direct kernel boot
}

message VmConfig {
  uint32 vcpus = 1;
  uint64 memory_mb = 2;

  // Boot configuration
  BootMode boot_mode = 9;         // DISK or KERNEL boot
  optional string kernel = 3;     // Required for KERNEL boot
  optional string initramfs = 4;  // Optional, for KERNEL boot
  optional string cmdline = 5;    // Optional, for KERNEL boot

  repeated DiskConfig disks = 6;
  repeated NicConfig nics = 7;
  optional string user_data = 8;  // cloud-init user-data (YAML content)

  // CPU features
  bool nested_virt = 10;          // Enable nested virtualization
}

message DiskConfig {
  string path = 1;
  bool readonly = 2;
}

message NicConfig {
  optional string tap = 1;           // TAP device name (for mvirt-ebpf or manual TAP)
  optional string mac = 2;           // MAC address
  optional string vhost_socket = 3;  // vhost-user socket path (for mvirt-net)
  // Note: Use either tap (for mvirt-ebpf) or vhost_socket (for mvirt-net), not both
}

// ============================================
// VM Service
// ============================================

service VmService {
  // System
  rpc GetVersion(GetVersionRequest) returns (VersionInfo);
  rpc GetSystemInfo(GetSystemInfoRequest) returns (SystemInfo);

  // CRUD
  rpc CreateVm(CreateVmRequest) returns (Vm);
  rpc GetVm(GetVmRequest) returns (Vm);
  rpc ListVms(ListVmsRequest) returns (ListVmsResponse);
  rpc DeleteVm(DeleteVmRequest) returns (DeleteVmResponse);

  // Lifecycle
  rpc StartVm(StartVmRequest) returns (Vm);
  rpc StopVm(StopVmRequest) returns (Vm);
  rpc KillVm(KillVmRequest) returns (Vm);

  // Hot-plug (Phase 2)
  rpc AttachDisk(AttachDiskRequest) returns (Vm);
  rpc DetachDisk(DetachDiskRequest) returns (Vm);
  rpc AttachNic(AttachNicRequest) returns (Vm);
  rpc DetachNic(DetachNicRequest) returns (Vm);

  // Console
  rpc Console(stream ConsoleInput) returns (stream ConsoleOutput);

  // Events
  rpc WatchVms(WatchVmsRequest) returns (stream VmEvent);
}

// ============================================
// Request/Response Messages
// ============================================

// System

message GetVersionRequest {}

message VersionInfo {
  string version = 1;
}

message GetSystemInfoRequest {}

message SystemInfo {
  // Basic info (existing)
  uint32 total_cpus = 1;
  uint64 total_memory_mb = 2;
  uint32 allocated_cpus = 3;
  uint64 allocated_memory_mb = 4;
  float load_1 = 5;
  float load_5 = 6;
  float load_15 = 7;

  // Detailed system info (new)
  HostInfo host = 10;
  CpuInfo cpu = 11;
  MemoryInfo memory = 12;
  repeated NumaNode numa_nodes = 13;
  repeated DiskInfo disks = 14;
  repeated NicInfo nics = 15;
}

message HostInfo {
  string hostname = 1;
  string kernel_version = 2;
  uint64 uptime_seconds = 3;
}

message CpuInfo {
  string model = 1;
  string vendor = 2;
  uint32 physical_cores = 3;
  uint32 logical_cores = 4;
  uint32 sockets = 5;
  repeated CpuCore cores = 6;
  repeated string flags = 7;  // vmx, svm, aes, etc.
}

message CpuCore {
  uint32 id = 1;
  uint64 frequency_mhz = 2;
  float usage_percent = 3;
  uint32 numa_node = 4;
}

message MemoryInfo {
  uint64 total_bytes = 1;
  uint64 available_bytes = 2;
  uint64 cached_bytes = 3;
  uint64 swap_total_bytes = 4;
  uint64 swap_used_bytes = 5;
  uint64 hugepages_total = 6;
  uint64 hugepages_free = 7;
  uint64 hugepage_size_kb = 8;
}

message NumaNode {
  uint32 id = 1;
  uint64 total_memory_bytes = 2;
  uint64 free_memory_bytes = 3;
  repeated uint32 cpu_ids = 4;
}

message DiskInfo {
  string device = 1;
  string model = 2;
  string serial = 3;
  uint64 size_bytes = 4;
  bool smart_available = 5;
  bool smart_healthy = 6;
  optional int32 temperature_celsius = 7;
  optional uint64 power_on_hours = 8;
}

message NicInfo {
  string name = 1;
  string mac = 2;
  bool is_up = 3;
  optional uint32 speed_mbps = 4;
  string duplex = 5;
  repeated string ipv4 = 6;
  repeated string ipv6 = 7;
  string driver = 8;
  uint64 rx_bytes = 9;
  uint64 tx_bytes = 10;
}

// CRUD

message CreateVmRequest {
  optional string name = 1;
  VmConfig config = 2;
}

message GetVmRequest {
  string id = 1;
}

message ListVmsRequest {}

message ListVmsResponse {
  repeated Vm vms = 1;
}

message DeleteVmRequest {
  string id = 1;
}

message DeleteVmResponse {}

// Lifecycle

message StartVmRequest {
  string id = 1;
}

message StopVmRequest {
  string id = 1;
  uint32 timeout_seconds = 2;
}

message KillVmRequest {
  string id = 1;
}

// Hot-plug

message AttachDiskRequest {
  string vm_id = 1;
  DiskConfig disk = 2;
}

message DetachDiskRequest {
  string vm_id = 1;
  string path = 2;
}

message AttachNicRequest {
  string vm_id = 1;
  NicConfig nic = 2;
}

message DetachNicRequest {
  string vm_id = 1;
  string mac = 2;
}

// Console

message ConsoleInput {
  string vm_id = 1;
  bytes data = 2;
}

message ConsoleOutput {
  bytes data = 1;
}

// Events

message WatchVmsRequest {
  optional string vm_id = 1;
}

message VmEvent {
  string vm_id = 1;
  VmEventType type = 2;
  int64 timestamp = 3;
  optional Vm vm = 4;
}

enum VmEventType {
  VM_EVENT_UNSPECIFIED = 0;
  VM_EVENT_CREATED = 1;
  VM_EVENT_STARTED = 2;
  VM_EVENT_STOPPED = 3;
  VM_EVENT_DELETED = 4;
}

// ============================================
// Pod Service - Container Pods in MicroVMs
// ============================================

service PodService {
  // CRUD
  rpc CreatePod(CreatePodRequest) returns (Pod);
  rpc GetPod(GetPodRequest) returns (Pod);
  rpc ListPods(ListPodsRequest) returns (ListPodsResponse);
  rpc DeletePod(DeletePodRequest) returns (DeletePodResponse);

  // Lifecycle
  rpc StartPod(StartPodRequest) returns (Pod);
  rpc StopPod(StopPodRequest) returns (Pod);

  // Container interaction
  rpc PodLogs(PodLogsRequest) returns (stream LogChunk);
  rpc PodExec(stream PodExecInput) returns (stream PodExecOutput);

  // Network info (proxied to mvirt-one)
  rpc GetPodNetworkInfo(GetPodNetworkInfoRequest) returns (PodNetworkInfo);
}

// ============================================
// Pod Types
// ============================================

enum PodState {
  POD_STATE_UNSPECIFIED = 0;
  POD_STATE_CREATED = 1;
  POD_STATE_STARTING = 2;
  POD_STATE_RUNNING = 3;
  POD_STATE_STOPPING = 4;
  POD_STATE_STOPPED = 5;
  POD_STATE_FAILED = 6;
}

enum ContainerState {
  CONTAINER_STATE_UNSPECIFIED = 0;
  CONTAINER_STATE_CREATING = 1;
  CONTAINER_STATE_CREATED = 2;
  CONTAINER_STATE_RUNNING = 3;
  CONTAINER_STATE_STOPPED = 4;
  CONTAINER_STATE_FAILED = 5;
}

message Pod {
  string id = 1;
  string name = 2;
  PodState state = 3;
  string vm_id = 4;                  // MicroVM hosting this pod
  repeated Container containers = 5;
  string ip_address = 6;
  int64 created_at = 7;
  optional int64 started_at = 8;
  optional string error_message = 9;
}

message Container {
  string id = 1;
  string name = 2;
  ContainerState state = 3;
  string image = 4;
  int32 exit_code = 5;
  optional string error_message = 6;
}

message ContainerSpec {
  string id = 1;                     // Unique container ID (auto-generated if empty)
  string name = 2;                   // Human-readable name
  string image = 3;                  // OCI Image Reference (e.g., "docker.io/library/alpine:latest")
  repeated string command = 4;       // Entrypoint command
  repeated string args = 5;          // Command arguments
  repeated string env = 6;           // Environment variables (KEY=VALUE format)
  string working_dir = 7;            // Working directory inside container
}

message PodResources {
  uint32 vcpus = 1;                  // vCPUs for the MicroVM
  uint64 memory_mb = 2;              // Memory for the MicroVM
  uint64 disk_size_gb = 3;           // Root disk size in GB (default: 4GB)
}

// ============================================
// Pod Request/Response Messages
// ============================================

message CreatePodRequest {
  optional string name = 1;
  repeated ContainerSpec containers = 2;
  optional PodResources resources = 3;  // Defaults: 1 vCPU, 256MB
  optional string root_disk_path = 4;   // Path to ZFS volume (VMM writes rootfs template)
  optional string nic_socket_path = 5;  // vhost-user socket path (from mvirt-net)
}

message GetPodRequest {
  string id = 1;
}

message ListPodsRequest {}

message ListPodsResponse {
  repeated Pod pods = 1;
}

message DeletePodRequest {
  string id = 1;
  bool force = 2;                    // Force delete even if running
}

message DeletePodResponse {}

message StartPodRequest {
  string id = 1;
}

message StopPodRequest {
  string id = 1;
  uint32 timeout_seconds = 2;        // Grace period before force kill (default: 10)
}

// Network Info (from mvirt-one inside the MicroVM)

message GetPodNetworkInfoRequest {
  string pod_id = 1;
}

message PodNetworkInfo {
  repeated PodInterfaceInfo interfaces = 1;
}

message PodInterfaceInfo {
  string name = 1;
  string mac_address = 2;

  // IPv4 configuration (from DHCPv4)
  string ipv4_address = 3;       // e.g., "10.0.0.5"
  string ipv4_netmask = 4;       // e.g., "255.255.255.0"
  string ipv4_gateway = 5;       // e.g., "10.0.0.1"
  repeated string ipv4_dns = 6;

  // IPv6 configuration (from SLAAC/DHCPv6)
  string ipv6_address = 7;       // e.g., "fd00::5"
  string ipv6_gateway = 8;       // Router from RA
  repeated string ipv6_dns = 9;

  // DHCPv6 Prefix Delegation
  string delegated_prefix = 10;  // e.g., "fd00:1234::/56"
}

// Container Logs

message PodLogsRequest {
  string pod_id = 1;
  optional string container_id = 2;  // Specific container, or all if empty
  bool follow = 3;                   // Stream logs continuously
  uint32 tail_lines = 4;             // Number of lines from end (0 = all)
}

message LogChunk {
  string container_id = 1;
  bytes data = 2;
  bool is_stderr = 3;
}

// Container Exec

message PodExecInput {
  oneof input {
    PodExecStart start = 1;
    bytes stdin = 2;
    PodExecResize resize = 3;
  }
}

message PodExecStart {
  string pod_id = 1;
  string container_id = 2;
  repeated string command = 3;
  bool tty = 4;
  repeated string env = 5;
}

message PodExecResize {
  uint32 width = 1;
  uint32 height = 2;
}

message PodExecOutput {
  oneof output {
    bytes stdout = 1;
    bytes stderr = 2;
    int32 exit_code = 3;
  }
}
